# Steam BA Record
[中文](https://github.com/shiikwi/SteamBARecord/blob/main/README_ZH.md)  
record and tools of steam Blue Archive

## il2cpp dump

Use: [frida-il2cpp-bridge](https://github.com/vfsfitvnm/frida-il2cpp-bridge)

```bash
npm install frida-il2cpp-bridge
npx frida-il2cpp-bridge -- -p PID dump
```

## Unity Asset
`BlueArchive_Data\StreamingAssets\PUB\Resource\GameData\Windows`  
`BlueArchive_Data\StreamingAssets\PUB\Resource\Preload\Windows`  
Use: [AssetStudio](https://github.com/Perfare/AssetStudio)

## Decompress ZIP
```csharp
class TableService
{
    static bool HasChanged;

    static TableService();
    static void ClearCache();
    static byte[] LoadBytes(string key, string extension, bool showFailedPopup);
    static string Load(string key, string extension);
    static string CreatePassword(string key, int length);
}
```
`CreatePassword`takes xxHash of filename with extension(*.zip). Convert to a decimal value as seed for Mersenne Twister.  
The Input `length`(fixed at 20) compute `(3 * length) >> 2` as byte array length  
Take bytes of pseudorandom generated by MT19937 then Base64-encoded  
Use: `DecpTableZip`  
```bash
DecpTableZip.exe <InputZIPFolder>
```

## Decrypt bytesfiles
```csharp
class TableEncryptionService
{
static byte[] CreateKey(string name);
static byte[] XOR(string name, byte[] bytes);
...
}
```
`XOR`uses case-sensitive filename without extension(PascalCase) to compute xxhash. Then Mersenne Twister generate byte stream for XOR  
Each`.bytes` file has matching c# class in dump.cs  
`GenXORKey.py`can generate key for `.bytes` file  
Use: `Decryptbytes`  
```bash
Decryptbytes.exe <InputBytesFolder>
```

## bytes2json
Decrypted `.bytes` file format is [Flatbuffer](https://github.com/google/flatbuffers). The value is still xor encrypted and strings are base64-encoded
Key generation follows the same method as above，just using filename with `ExcelTable` removed    
Use: [Flatbuffer](https://github.com/google/flatbuffers/releases/) to generated C#，refer to [fbs](https://github.com/shiikwi/SteamBARecord/blob/main/fbs/AcademyFavorSchedule.fbs)
```bash
flatc.exe --csharp -o . xxx.fbs
```
Use: `Flatbuffer2json`  
Change inputfilename，then it will dump to json
